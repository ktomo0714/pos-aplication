# データ定義書

## 概要
POSアプリケーションのデータベース定義書(Lv1)  
**データベース**: Azure Database for MySQL

---

## テーブル一覧

| No | テーブル物理名 | テーブル論理名 | 説明 |
|----|--------------|--------------|------|
| 1 | product_master | 商品マスタ | 商品情報を管理 |
| 2 | transaction | 取引 | 取引ヘッダー情報を管理 |
| 3 | transaction_detail | 取引明細 | 取引の明細情報を管理 |

---

## 1. product_master (商品マスタ)

### テーブル概要
商品情報を管理するマスタテーブル

### テーブル定義

| 項目名(論理) | 項目名(物理) | データ型 | 桁数 | PK | NULL許可 | デフォルト値 | 備考 |
|------------|------------|---------|------|----|---------|------------|------|
| 商品一意キー | PRD_ID | INT | - | ○ | × | AUTO_INCREMENT | 主キー、自動採番 |
| 商品コード | CODE | CHAR | 13 | - | × | - | UNIQUE制約 |
| 商品名称 | NAME | VARCHAR | 50 | - | ○ | NULL | NULL許可(API仕様より) |
| 商品単価 | PRICE | INT | - | - | ○ | NULL | NULL許可(API仕様より) |

### 制約
- PRIMARY KEY: PRD_ID
- UNIQUE KEY: CODE
- API「商品マスタ検索」で、商品コードに一致する商品情報を1件返却
- 対象見つからない場合はNULL情報を返却

---

## 2. transaction (取引)

### テーブル概要
取引のヘッダー情報を管理するテーブル

### テーブル定義

| 項目名(論理) | 項目名(物理) | データ型 | 桁数 | PK | NULL許可 | デフォルト値 | 備考 |
|------------|------------|---------|------|----|---------|------------|------|
| 取引一意キー | TRD_ID | INT | - | ○ | × | AUTO_INCREMENT | 主キー、自動採番(1〜) |
| 取引日時 | DATETIME | TIMESTAMP | - | - | × | CURRENT_TIMESTAMP | システム日付固定 |
| レシ担当者コード | EMP_CD | CHAR | 10 | - | × | '9999999999' | デフォルト値固定 |
| 店舗コード | STORE_CD | CHAR | 5 | - | × | - | 30固定 |
| POS機ID | POS_NO | CHAR | 3 | - | × | '90' | 90固定、モバイルレジという意味 |
| 合計金額 | TOTAL_AMT | INT | - | - | × | 0 | デフォルト0 |

### 制約
- PRIMARY KEY: TRD_ID
- INDEX: DATETIME (検索用)

### API仕様との関連
- 購入API(1-1): 取引テーブルへ登録
  - 取引一意キー: 採番インクリメンタル 1〜
  - 取引日時: 現在日時(システム日付)
  - レシ担当者コード: パラメータ、空白の場合は'9999999999'
  - 店舗コード: '30'固定
  - POS機ID: '90'固定
  - 合計金額: 0 (初期値)

---

## 3. transaction_detail (取引明細)

### テーブル概要
取引の明細情報を管理するテーブル

### テーブル定義

| 項目名(論理) | 項目名(物理) | データ型 | 桁数 | PK | NULL許可 | デフォルト値 | 備考 |
|------------|------------|---------|------|----|---------|------------|------|
| 取引一意キー | TRD_ID | INT | - | ○ | × | - | 主キー、外部キー(transaction) |
| 取引明細一意キー | DTL_ID | INT | - | ○ | × | - | 主キー、採番インクリメンタル 1〜/取引ごと |
| 商品一意キー | PRD_ID | INT | - | - | × | - | 外部キー(product_master) |
| 商品コード | PRD_CODE | CHAR | 13 | - | × | - | パラメータから設定 |
| 商品名称 | PRD_NAME | VARCHAR | 50 | - | × | - | パラメータから設定 |
| 商品単価 | PRD_PRICE | INT | - | - | × | - | パラメータから設定 |

### 制約
- PRIMARY KEY: (TRD_ID, DTL_ID)
- FOREIGN KEY: TRD_ID → transaction(TRD_ID) ON DELETE CASCADE
- FOREIGN KEY: PRD_ID → product_master(PRD_ID)
- INDEX: PRD_ID (検索用)

### API仕様との関連
- 購入API(1-2): 取引明細へ登録
  - 取引一意キー: 1-1で登録後の値
  - 取引明細一意キー: 採番インクリメンタル 1〜/取引ごと
  - 商品一意キー: パラメータ
  - 商品コード: パラメータ
  - 商品名称: パラメータ
  - 商品単価: パラメータ

---

## ER図の関連

### product_master → transaction_detail
- カーディナリティ: 1:0以上
- 関連: 商品マスタの1件に対して、取引明細が0件以上存在する

### transaction → transaction_detail
- カーディナリティ: 1:1以上
- 関連: 取引の1件に対して、取引明細が1件以上存在する
- 取引削除時は明細も連動削除(CASCADE)

---

## API機能一覧

### 1. 商品マスタ検索
- **パラメータ**: コード(商品コードのこと)
- **リターン**: 商品情報(商品一意キー/商品コード/商品名称/商品単価)
- **処理**: 
  - パラメータのコードに一致する商品コードの商品を1件返却
  - 対象見つからなかった場合はNULL情報を返却

### 2. 購入
- **パラメータ**: レシ担当者コード、店舗コード、POS機ID、(商品リスト分)商品一意キー、商品コード、商品名称、商品単価
- **リターン**: 成否(True/False)、合計金額
- **処理**:
  - 1-1: 取引テーブルへ登録
  - 1-2: 取引明細へ登録
  - 1-3: 合計を計算(繰り返し処理)商品単価を変数"V_合計金額"へ足し込んで合計金額作成
  - 1-4: 取引テーブルを更新(更新条件: 取引一意キー(1-10登録後の値)、更新値: 合計金額(V_合計金額))
  - 1-5: 合計金額をフロントへ返却

---

## 備考
- Azure Database for MySQL 8.0以上を想定
- 文字コード: utf8mb4
- 照合順序: utf8mb4_unicode_ci
- ストレージエンジン: InnoDB
- AUTO_INCREMENT使用によりシーケンス管理は不要
